from .grafo_utils import dijkstra

def eficiencia_global(grafo):
    vertices = list(grafo.keys())
    numVertices = len(vertices)

    somatorioEficiencia = 0.0

    for noh_1  in vertices:
        _, Distancia, _, _ = dijkstra(grafo, noh_1)

        for noh_2 in vertices:
            if noh_1 == noh_2:
                continue

            distancia = Distancia[noh_2]

            if distancia != float('inf'):
                somatorioEficiencia += 1.0 / distancia

    eficienciaGlobal = somatorioEficiencia / (numVertices * (numVertices - 1))
    return eficienciaGlobal


def remover_aresta(grafo, noh_1, noh_2):
    distancia = grafo[noh_1][noh_2]
    del grafo[noh_1][noh_2]
    del grafo[noh_2][noh_1]
    return distancia


def recolocar_aresta(grafo, noh_1, noh_2, distancia):
    grafo[noh_1][noh_2] = distancia
    grafo[noh_2][noh_1] = distancia


#Retorna uma lista de tuplas: [((Noh_1, Noh_2), vulnerabilidadeAresta), ...]
def vulnerabilidade_rede(grafo):
    vertices = list(grafo.keys())

    #1)Calculo da Eficiência Global Original
    eficienciaOriginal = eficiencia_global(grafo)

    if eficienciaOriginal == 0:
        #Nessas condições, a vulnerabilidade relativa nao eh bem definida
        #Eficiência global = 0 -> implica em uma rede desconexa
        return []

    #2)Criacao da lista de arestas únicas (noh_1 < noh_2)
    arestas = []
    for noh_1 in vertices:
        for noh_2 in grafo[noh_1].keys():
            if noh_1 < noh_2:
                arestas.append((noh_1, noh_2))

    listaVulnerabilidadeAresta = []

    #3)Calculo da nova eficiência para cada aresta removida
    for (noh_1, noh_2) in arestas:
        distanciaOriginal = remover_aresta(grafo, noh_1, noh_2)

        eficienciaArestaRemovida = eficiencia_global(grafo)

        vulnerabilidadeAresta = (eficienciaOriginal - eficienciaArestaRemovida) / eficienciaOriginal

        listaVulnerabilidadeAresta.append(((noh_1, noh_2), vulnerabilidadeAresta))

        recolocar_aresta(grafo, noh_1, noh_2, distanciaOriginal)

    return listaVulnerabilidadeAresta